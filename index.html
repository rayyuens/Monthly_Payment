window.openDetails = (idx) => {
    const key = getMonthKey();
    const items = allExpenses[key] || [];
    const name = roommateNames[idx];

    // 1. è¨ˆç®—å¢Šæ”¯é …ç›® (Paid Upfront)
    let upfrontHtml = `<b style="color:var(--primary); font-size:14px;">ðŸ’° You Paid Upfront:</b><br>`;
    let upfrontItems = items.filter(item => item.payers[idx]);
    
    if(upfrontItems.length === 0) {
        upfrontHtml += `<span style="color:gray; font-size:12px;">(No payments made)</span><br>`;
    } else {
        upfrontItems.forEach(i => {
            const payersCount = i.payers.filter(Boolean).length;
            upfrontHtml += `<div class="detail-row"><span>â€¢ ${i.name}</span> <span>$${(i.amount/payersCount).toFixed(2)}</span></div>`;
        });
    }

    // 2. è¨ˆç®—è²¬ä»»é …ç›® (Responsible for / Share)
    let shareHtml = `<br><b style="color:var(--text); font-size:14px;">ðŸ§¾ Included in your "Share":</b><br>`;
    let shareCount = 0;

    items.forEach(item => {
        let shareAmt = item.customAmounts ? item.customAmounts[idx] : (item.splitBetween[idx] ? item.amount / item.splitBetween.filter(Boolean).length : 0);
        
        if (shareAmt > 0) {
            shareCount++;
            const status = item.paidBy[idx] ? 'âœ…' : 'âŒ';
            const paidByNames = roommateNames.filter((_, pIdx) => item.payers[pIdx]).join(' & ');
            
            shareHtml += `
            <div style="display:flex; flex-direction:column; border-bottom:1px solid #F2F2F7; padding:8px 0;">
                <div style="display:flex; justify-content:space-between; ${item.paidBy[idx] ? 'color:#aaa; text-decoration:line-through' : ''}">
                    <span>${status} ${item.name}</span> 
                    <span style="font-weight:600;">$${shareAmt.toFixed(2)}</span>
                </div>
                <div style="font-size:10px; color:#8E8E93; margin-top:2px;">
                    Payer: <span style="color:#555;">${paidByNames || 'System'}</span>
                </div>
            </div>`;
        }
    });

    if(shareCount === 0) shareHtml += `<span style="color:gray; font-size:12px;">(No responsibilities)</span>`;

    // æ¸²æŸ“åˆ° Modal
    document.getElementById('detailUserName').innerText = name + "'s Breakdown";
    document.getElementById('detailContent').innerHTML = upfrontHtml + shareHtml;
    document.getElementById('modalOverlay').style.display = 'block';
    document.getElementById('detailModal').style.display = 'block';
};
